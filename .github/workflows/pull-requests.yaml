name: Build and Upload to Artifactory (JFrog CLI)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-upload:
    runs-on: [self-hosted, linux, x64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Bazel
        uses: bazel-contrib/setup-bazel@0.8.1
        with:
          bazelisk-cache: true
      
      - name: Build with Bazel
        run: |
          bazel build --config=atmega32u4 //machine/sumobotBlackMagic:app
      
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v3
        env:
          JF_URL: ${{ secrets.ARTIFACTORY_URL }}
          JF_USER: ${{ secrets.ARTIFACTORY_USER }}
          JF_PASSWORD: ${{ secrets.ARTIFACTORY_API_KEY }}
      
      - name: Upload artifacts to Artifactory
        run: |
          # Create timestamp folder name
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")

          # Upload the built artifacts
          jfrog rt upload \
            "bazel-bin/machine/sumobotBlackMagic/app*" \
            "builds-local/sumobotBlackMagic/${TIMESTAMP}/" \
            --flat=false \
            --build-name=sumobotBlackMagic \
            --build-number=${{ github.run_number }}
          
          # Publish build info
          jfrog rt build-publish sumobotBlackMagic ${{ github.run_number }}
      
      - name: List uploaded artifacts
        run: |
          echo "Artifacts uploaded to:"
          echo "${{ secrets.ARTIFACTORY_URL }}/sumobotBlackMagic/${TIMESTAMP}/"