name: sumobotBlackMagic

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-upload:
    runs-on: [self-hosted, linux, x64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Bazel
        uses: bazel-contrib/setup-bazel@0.8.1
        with:
          bazelisk-cache: true
      
      - name: Build with Bazel
        run: |
          bazel build --config=atmega32u4 //machine/sumobotBlackMagic:app
      
      - name: List build outputs
        run: |
          echo "Build outputs:"
          find bazel-bin/machine/sumobotBlackMagic -type f
      
      - name: Copy artifacts to staging directory
        run: |
          mkdir -p artifacts
          # Copy all build outputs
          find bazel-bin/machine/sumobotBlackMagic -type f \( -name "*.hex" -o -name "*.elf" -o -name "*.bin" -o -name "app" \) -exec cp {} artifacts/ \;
          echo "Artifacts to upload:"
          ls -lh artifacts/
      
      - name: Upload to Artifactory with curl
        env:
          ARTIFACTORY_URL: ${{ secrets.ARTIFACTORY_URL }}
          ARTIFACTORY_USER: ${{ secrets.ARTIFACTORY_USER }}
          ARTIFACTORY_API_KEY: ${{ secrets.ARTIFACTORY_API_KEY }}
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          
          for file in artifacts/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "Uploading $filename..."
              curl -u $ARTIFACTORY_USER:$ARTIFACTORY_API_KEY \
                -X PUT \
                -T "$file" \
                "$ARTIFACTORY_URL/builds-local/sumobotBlackMagic/${TIMESTAMP}/$filename"
              
              if [ $? -eq 0 ]; then
                echo "✓ Successfully uploaded $filename"
              else
                echo "✗ Failed to upload $filename"
                exit 1
              fi
            fi
          done
          
          echo "All artifacts uploaded to: $ARTIFACTORY_URL/builds-local/sumobotBlackMagic/${TIMESTAMP}/"